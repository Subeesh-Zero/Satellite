<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ProStream IPTV Player</title>

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- FontAwesome for Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

    <style>
        :root {
            --sidebar-width: 350px;
            --primary-color: #3b82f6;
            --bg-dark: #0f1014;
            --bg-panel: #181a20;
            --border-color: #262a34;
        }

        body {
            background-color: var(--bg-dark);
            color: #e0e0e0;
            font-family: 'Inter', sans-serif;
            overflow: hidden; /* Prevent body scroll, handle in containers */
        }

        /* --- Layout --- */
        .app-container {
            display: flex;
            height: 100vh;
            width: 100vw;
        }

        /* --- Sidebar (Channel List) --- */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--bg-panel);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            z-index: 1000;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-panel);
        }

        .channel-list {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
        }

        /* Custom Scrollbar */
        .channel-list::-webkit-scrollbar {
            width: 6px;
        }
        .channel-list::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 3px;
        }

        .channel-item {
            padding: 12px 20px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
        }

        .channel-item:hover {
            background: #232730;
            padding-left: 25px; /* Slight slide effect */
        }

        .channel-item.active {
            background: rgba(59, 130, 246, 0.15);
            border-left: 3px solid var(--primary-color);
            color: var(--primary-color);
            font-weight: 600;
        }

        /* --- Main Content (Player) --- */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            background: #000;
        }

        .player-wrapper {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #000;
        }

        video {
            width: 100%;
            max-height: 100vh;
            outline: none;
        }

        /* --- Custom Controls Overlay --- */
        .video-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 10;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
            padding: 8px 12px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
            opacity: 0; 
            transition: opacity 0.3s;
        }

        .player-wrapper:hover .video-controls {
            opacity: 1;
        }

        .quality-select {
            background: transparent;
            color: #fff;
            border: 1px solid #555;
            border-radius: 4px;
            padding: 2px 5px;
            font-size: 0.8rem;
            cursor: pointer;
        }
        
        .quality-select:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        /* --- Mobile Responsive --- */
        .mobile-header {
            display: none;
            padding: 10px 15px;
            background: var(--bg-panel);
            border-bottom: 1px solid var(--border-color);
            align-items: center;
            justify-content: space-between;
        }

        @media (max-width: 992px) {
            .app-container {
                flex-direction: column;
            }

            .mobile-header {
                display: flex;
            }

            .sidebar {
                position: fixed;
                top: 0;
                left: 0;
                height: 100%;
                transform: translateX(-100%);
            }

            .sidebar.show {
                transform: translateX(0);
                box-shadow: 5px 0 15px rgba(0,0,0,0.5);
            }

            .main-content {
                height: calc(100vh - 55px); /* Adjust for header */
            }
            
            /* Always show controls on mobile touch */
            .video-controls {
                opacity: 1; 
                top: 10px;
                right: 10px;
            }
        }

        /* Loading Spinner */
        .loader-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
            display: none;
        }

        .search-input {
            background: #232730;
            border: 1px solid #2f3440;
            color: #fff;
        }
        .search-input:focus {
            background: #232730;
            border-color: var(--primary-color);
            color: #fff;
            box-shadow: none;
        }
    </style>
</head>
<body>

    <!-- Mobile Header -->
    <div class="mobile-header">
        <div class="d-flex align-items-center gap-2">
            <button class="btn btn-sm btn-outline-secondary" id="sidebarToggle">
                <i class="fa-solid fa-bars"></i>
            </button>
            <span class="fw-bold">ProStream</span>
        </div>
        <div id="mobileStatus" class="small text-muted">Select Channel</div>
    </div>

    <div class="app-container">
        
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="m-0 fw-bold"><i class="fa-solid fa-tv me-2 text-primary"></i>Channels</h5>
                    <button class="btn btn-sm btn-link text-muted d-lg-none" id="closeSidebar">
                        <i class="fa-solid fa-times"></i>
                    </button>
                </div>
                <div class="input-group">
                    <span class="input-group-text bg-dark border-secondary text-secondary"><i class="fa-solid fa-search"></i></span>
                    <input type="text" id="searchInput" class="form-control search-input" placeholder="Search (e.g. News, Sport)...">
                </div>
            </div>
            
            <div class="channel-list" id="channelList">
                <!-- Channels injected here -->
                <div class="text-center mt-5 text-muted">
                    <div class="spinner-border text-primary mb-2" role="status"></div>
                    <p>Loading Playlist...</p>
                </div>
            </div>
            <div id="sentinel" style="height: 10px;"></div> <!-- Infinite Scroll Sentinel -->
        </div>

        <!-- Main Player Area -->
        <div class="main-content">
            <div class="player-wrapper">
                <div class="loader-overlay" id="videoLoader">
                    <div class="spinner-border text-light" role="status"></div>
                </div>

                <!-- Custom Controls for Quality -->
                <div class="video-controls" id="videoControls">
                    <span class="badge bg-danger" id="liveBadge">LIVE</span>
                    <select id="qualitySelect" class="quality-select">
                        <option value="-1">Auto</option>
                    </select>
                </div>

                <video id="video" controls autoplay playsinline></video>
            </div>
        </div>

    </div>

    <!-- HLS.js -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // --- Configuration ---
        // Using a general playlist. NOTE: Some links in free playlists expire or break.
        const M3U_URL = "https://iptv-org.github.io/iptv/index.m3u"; 
        
        // --- Elements ---
        const video = document.getElementById("video");
        const channelListEl = document.getElementById("channelList");
        const searchInput = document.getElementById("searchInput");
        const sidebar = document.getElementById("sidebar");
        const sidebarToggle = document.getElementById("sidebarToggle");
        const closeSidebar = document.getElementById("closeSidebar");
        const qualitySelect = document.getElementById("qualitySelect");
        const videoLoader = document.getElementById("videoLoader");
        const mobileStatus = document.getElementById("mobileStatus");
        const sentinel = document.getElementById("sentinel");

        // --- State ---
        let allChannels = [];
        let filteredChannels = [];
        let displayedCount = 0;
        const BATCH_SIZE = 50; // Render 50 at a time for performance
        let hls = null;

        // --- Initialization ---
        document.addEventListener("DOMContentLoaded", () => {
            fetchPlaylist();
            setupEventListeners();
        });

        // --- Playlist Logic ---
        async function fetchPlaylist() {
            try {
                const response = await fetch(M3U_URL);
                if (!response.ok) throw new Error("Network response was not ok");
                const data = await response.text();
                parseM3U(data);
            } catch (error) {
                channelListEl.innerHTML = `<div class="p-4 text-danger text-center">Failed to load playlist.<br><small>${error.message}</small></div>`;
            }
        }

        function parseM3U(data) {
            const lines = data.split("\n");
            allChannels = [];
            
            let currentChannel = {};

            lines.forEach(line => {
                line = line.trim();
                if (!line) return;

                if (line.startsWith("#EXTINF:")) {
                    // Extract name (everything after the last comma)
                    const nameParts = line.split(",");
                    currentChannel.name = nameParts[nameParts.length - 1].trim();
                    
                    // Optional: Try to get logo (tvg-logo)
                    const logoMatch = line.match(/tvg-logo="([^"]*)"/);
                    if (logoMatch) currentChannel.logo = logoMatch[1];
                } else if (!line.startsWith("#")) {
                    currentChannel.url = line;
                    // Add valid channel to list
                    if (currentChannel.name && currentChannel.url) {
                        allChannels.push({...currentChannel});
                    }
                    currentChannel = {}; // Reset
                }
            });

            // Initial Render
            filteredChannels = allChannels;
            channelListEl.innerHTML = ""; // Clear loading spinner
            renderMoreChannels();
        }

        // --- Rendering & Infinite Scroll ---
        function renderMoreChannels() {
            const fragment = document.createDocumentFragment();
            const nextBatch = filteredChannels.slice(displayedCount, displayedCount + BATCH_SIZE);

            if (nextBatch.length === 0) return;

            nextBatch.forEach(ch => {
                const div = document.createElement("div");
                div.className = "channel-item";
                div.innerHTML = `
                    <i class="fa-solid fa-play-circle text-muted"></i>
                    <span class="text-truncate">${ch.name}</span>
                `;
                div.onclick = () => loadChannel(ch, div);
                fragment.appendChild(div);
            });

            channelListEl.appendChild(fragment);
            displayedCount += nextBatch.length;
        }

        // Setup Intersection Observer for Infinite Scroll
        const observer = new IntersectionObserver(entries => {
            if (entries[0].isIntersecting) {
                renderMoreChannels();
            }
        });
        observer.observe(sentinel);

        // --- Search Logic ---
        searchInput.addEventListener("input", (e) => {
            const term = e.target.value.toLowerCase();
            channelListEl.innerHTML = ""; // Clear list
            displayedCount = 0;
            
            if (term.length < 1) {
                filteredChannels = allChannels;
            } else {
                filteredChannels = allChannels.filter(ch => ch.name.toLowerCase().includes(term));
            }
            renderMoreChannels();
        });

        // --- Player Logic ---
        function loadChannel(channel, el) {
            // UI Updates
            document.querySelectorAll(".channel-item").forEach(c => c.classList.remove("active"));
            if(el) el.classList.add("active");
            
            mobileStatus.textContent = channel.name;
            videoLoader.style.display = "flex";
            
            // Mobile: Close sidebar on selection
            if(window.innerWidth < 992) {
                sidebar.classList.remove("show");
            }

            // HLS Setup
            if (Hls.isSupported()) {
                if (hls) {
                    hls.destroy();
                }
                
                hls = new Hls({
                    maxBufferLength: 30, // Tuning for stability
                    maxMaxBufferLength: 600
                });

                hls.loadSource(channel.url);
                hls.attachMedia(video);

                hls.on(Hls.Events.MANIFEST_PARSED, (event, data) => {
                    video.play().catch(e => console.log("Autoplay prevented"));
                    videoLoader.style.display = "none";
                    updateQualityOptions(hls.levels);
                });

                hls.on(Hls.Events.ERROR, function (event, data) {
                    if (data.fatal) {
                        videoLoader.innerHTML = `<span class="text-danger">Stream Error</span>`;
                        // Retry logic could go here
                    }
                });

            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                // Native Safari support
                video.src = channel.url;
                video.addEventListener('loadedmetadata', () => {
                    video.play();
                    videoLoader.style.display = "none";
                });
                // Native player doesn't expose manual quality switching easily via JS
                qualitySelect.style.display = "none"; 
            }
        }

        // --- Quality Switching Logic ---
        function updateQualityOptions(levels) {
            qualitySelect.innerHTML = ""; // Clear existing
            
            // Add Auto Option
            const autoOpt = document.createElement("option");
            autoOpt.value = -1;
            autoOpt.text = "Auto";
            qualitySelect.appendChild(autoOpt);

            // Add available levels
            if (levels.length > 0) {
                levels.forEach((level, index) => {
                    const opt = document.createElement("option");
                    opt.value = index;
                    // Format: 720p (2500kbps)
                    const bitrate = (level.bitrate / 1000).toFixed(0);
                    const height = level.height ? level.height + 'p' : 'Unknown';
                    opt.text = `${height} (${bitrate}k)`;
                    qualitySelect.appendChild(opt);
                });
                qualitySelect.style.display = "block";
            } else {
                qualitySelect.style.display = "none"; // Hide if single stream
            }
        }

        qualitySelect.addEventListener("change", (e) => {
            if (hls) {
                hls.currentLevel = parseInt(e.target.value);
            }
        });

        // --- UI Interactions ---
        function setupEventListeners() {
            sidebarToggle.addEventListener("click", () => {
                sidebar.classList.toggle("show");
            });

            closeSidebar.addEventListener("click", () => {
                sidebar.classList.remove("show");
            });

            // Hide loader when playing starts
            video.addEventListener('playing', () => {
                videoLoader.style.display = "none";
            });
            
            video.addEventListener('waiting', () => {
                videoLoader.style.display = "flex";
            });
        }

    </script>
</body>
</html>
